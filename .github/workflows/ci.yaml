name: CI
permissions:
  contents: read
  pull-requests: write
  checks: write
on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10.15.1
          run_install: false

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Check TypeScript Types
        run: npx turbo check-types

  lint-changed-files:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: pnpm/action-setup@v4
        name: Install pnpm
        with:
          version: 10.15.1
          run_install: false

      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Reviewdog
        uses: reviewdog/action-setup@v1

      - name: Lint Changed Files
        shell: bash
        env:
          REVIEWDOG_GITHUB_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git fetch origin "${{ github.base_ref }}" --depth=1

          BASE_SHA="$(git merge-base "origin/${{ github.base_ref }}" "${{ github.event.pull_request.head.sha }}")"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          mapfile -t changed_files < <(git diff --name-only --diff-filter=ACMR "$BASE_SHA" "$HEAD_SHA")

          if [ ${#changed_files[@]} -eq 0 ]; then
            echo "No files changed in this pull request."
            exit 0
          fi

          declare -A workspace_to_files
          lintable_count=0

          for file in "${changed_files[@]}"; do
            case "$file" in
              *.js|*.jsx|*.ts|*.tsx|*.mjs|*.cjs) ;;
              *) continue ;;
            esac

            if [ ! -f "$file" ]; then
              continue
            fi

            IFS='/' read -r top_level workspace_name _ <<< "$file"
            if [ -z "${top_level:-}" ] || [ -z "${workspace_name:-}" ]; then
              continue
            fi

            workspace="${top_level}/${workspace_name}"
            if [ ! -f "${workspace}/eslint.config.mjs" ]; then
              continue
            fi

            relative_file="${file#${workspace}/}"
            if [ "$relative_file" = "$file" ]; then
              continue
            fi

            workspace_to_files["$workspace"]+="${relative_file}"$'\n'
            lintable_count=$((lintable_count + 1))
          done

          if [ "$lintable_count" -eq 0 ]; then
            echo "No changed lintable files in workspaces with ESLint configs."
            exit 0
          fi

          for workspace in "${!workspace_to_files[@]}"; do
            echo "Linting changed files in ${workspace}"
            mapfile -t files < <(printf '%s' "${workspace_to_files[$workspace]}" | sed '/^$/d')
            pnpm --dir "$workspace" exec eslint --max-warnings 0 "${files[@]}" | reviewdog \
              -f=eslint \
              -name="eslint (${workspace})" \
              -reporter=github-pr-check \
              -filter-mode=added \
              -level=warning
          done
